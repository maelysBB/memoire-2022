{% extends "base.html" %}
{% block title %}Home Page{% endblock %}
{% block content %}

<div id="set_map"></div>


<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
  <div class="offcanvas-header">
    <h5> Que recherchez vous dans la zone?</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

<input id="input" type="range" min="0" value="1" max="3" step="1" style="width:80% ; position:block; margin-left: auto; margin-right: auto">
<div id="output" style="width:80% ; position:block; margin-left: auto; margin-right: auto"></div>

<script language="JavaScript">
var values = [500,1000,5000,10000];
var input = document.getElementById('input'),
   output = document.getElementById('output');
input.oninput = function(){
    output.innerHTML = values[this.value];
};
input.oninput();


</script>

  <div class="offcanvas-body">
    <form id = "myform"  onsubmit="return false">
      {% for key,value in list_of_choices.items() %}
        <div class = "section_category" id = "{{key}}">
          <strong>{{value.groupe}}</strong>
            {% if value.category %}
              <div class = "section_header">
                <input class="form-check-input" type="checkbox" id="champ1"onClick="toggle(this, '{{key}}')" /> <label>{{value.name}} (tous types) </label>
                <button id ="but-{{loop.index0}}" type="button" class="collapsible" onClick = "collapse(this)"><img srcset="https://img.icons8.com/external-others-inmotus-design/134/external-Down-virtual-keyboard-others-inmotus-design-5.png 2x" alt="Down" loading="lazy" onload="this.setAttribute('lazy', 'loaded')" onerror="this.setAttribute('lazy', 'error')" style="width: 18px; height: 18px;" lazy="loaded">       </button> 
              </div>
              <div class = "content {{loop.index0}}">
              {% for element in value.category %}
                <div class = "section_checkboxes">
                  <label class="form-check">
                    <input class="form-check-input real {{key}}" type="checkbox" name = "user_demand" value="{{key}}{{loop.index0}}">
                    <span class="form-check-label">
                      {{element}}
                    </span>
                  </label> 
                </div>
              {% endfor %}
              {% if value.title %} 
              <div>
                 <span>Un nom vous revient ? </span>
                <input type="text" class="form-control" aria-label="Default" name = "name_{{key}}" aria-describedby="inputGroup-sizing-default">
              </div>
              {% endif %}
            </div>  
 
            {% elif value.title %} 
            <div class = "section_header">
              <input class="form-check-input" type="checkbox" id="champ1"onClick="toggle(this, '{{key}}')" /> <label>{{value.name}}</label>
              <button id ="but-{{loop.index0}}" type="button" class="collapsible" onClick = "collapse(this)"><img srcset="https://img.icons8.com/external-others-inmotus-design/134/external-Down-virtual-keyboard-others-inmotus-design-5.png 2x" alt="Down" loading="lazy" onload="this.setAttribute('lazy', 'loaded')" onerror="this.setAttribute('lazy', 'error')" style="width: 18px; height: 18px;" lazy="loaded">       </button> 
            </div>
            <div class = "content {{loop.index0}}">
              <span>Un nom vous revient ? </span>
              <input type="text" class="form-control" aria-label="Default" name = "name_{{key}}" aria-describedby="inputGroup-sizing-default">
            </div>


            {%else%}
            <div class = "section_header">
              <input class="form-check-input real" type="checkbox" name = "user_demand" value="{{key}}">
              {{value.name}}
            </div>   

            {% endif %}
        </div>    
      {% endfor %}
      <button type="submit" class="btn btn-primary btn-block btn-large" onClick = getValues()>Trouvez des lieux</button>  

    </form>
  </div>
</div>
<div>
  <a class="btn btn-dark filter" data-bs-toggle="offcanvas" href="#offcanvasExample" role="button" aria-controls="offcanvasExample">
    Filtrer
  </a>

  <a class="btn btn-dark filter" id="menu_right" href="/" role="button">
    Retour au menu principal
</a>
</div>


<script language="JavaScript">
  function toggle(source, key) {
  checkboxes = document.getElementsByClassName("form-check-input "+key);
  for(var i=0, n=checkboxes.length;i<n;i++) {
    checkboxes[i].checked = source.checked;
  }
} 

</script>

<script language="JavaScript">
  function getValues() {
    var array_checkboxes = []
    var array_inputs = {}

    var markedCheckbox = document.querySelectorAll('input[type="checkbox"]:checked.real');

    for (var checkbox of markedCheckbox) {  
      array_checkboxes.push(checkbox.value);  
    }
    
    var textInputs = document.querySelectorAll('input[type="text"]');  
    for (var text of textInputs) {  
      array_inputs[text.name] = text.value;  
  }
    var distance = values[document.getElementById('input').value];


  if (window.myLayer)
    { window.myLayer.clearLayers()}

  window.myLayer = L.geoJSON().addTo(map);

  var data =  JSON.stringify({"checkboxes": array_checkboxes, "inputs": array_inputs, "distance":distance})
  const process_demand = "{{ url_for('update_map_api') }}"
  console.log(data)
    
    fetch(process_demand,  {method: "POST", body:  data,  headers: {
    'Content-Type': 'application/json'
  } 
  })
    .then(response => response.json())
    .then(data => {
         try { 
          data = JSON.parse(data);
          window.myLayer.addData(data);  

          // var message='test'
          // window.myLayer.bindPopup(message)

        } catch (e) { alert("Aucun résultat trouvé"); }
  
        // window.myLayer.addData(data);       
    })
  
    

  }
</script>
<!-- <script>
    function myFunction() {
      var e = document.getElementById("map").contentWindow.document.getElementsByTagName("span")[0];
        e.innerHTML = "fuck"
        e.style.color = "white";
    }
</script> -->


<script type="text/javascript">
  var map = L.map('set_map').setView([48.9, 2.3360300], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

 
  </script>

{% endblock %}

<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
